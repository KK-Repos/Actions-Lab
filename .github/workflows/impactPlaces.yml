name: Impact Agent

on:
  workflow_dispatch:
    inputs:
     Agent:
        type: choice
        description: 'Do you want to run Impact agent'
        required: true
        default: no
        options:
        - yes
        - no
env:
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  review_bot:
    name: Impact places
    runs-on: test
    timeout-minutes: 8
    environment: test
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Get PR Number
        run: |
          PR_NUMBER=$(curl -s -H "Authorization: Bearer ${{ env.GITHUB_TOKEN }}" \
                          "https://api.github.com/repos/klenty/transcripts-service/pulls?head=klenty:${{ github.ref_name }}" | jq -r '.[0].number')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
      
      
      - name: Install dependencies
        env: 
          NODE_ENV: development
        run: npm i -D acorn-walk @typescript-eslint/parser split 

      - name: Run Impact Agent
        env:
            GITHUB_TOKEN: ${{ secrets.API_TOKEN }}
            GITHUB_CONTEXT: ${{ toJson(github) }}
            BRANCH_NAME: ${{ github.ref_name  }}

        run: node impactAgent.js